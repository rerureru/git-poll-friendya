<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">
    
<sqlMap namespace="board">
	<typeAlias alias="BoardModel" type="net.nice19.smboard.board.model.BoardModel"/>
	<typeAlias alias="BoardCommentModel" type="net.nice19.smboard.board.model.BoardCommentModel"/>	
	<select id="getBoardList" parameterClass="java.util.HashMap" resultClass="BoardModel">
		select 
			b.boardid, b.nickname, b.subject,
			b.content, b.hitcnt, b.recommendcnt,
			DATE_FORMAT(b.createdate, '%Y-%m-%d %H:%i:%s') writeDate,
			count(c.commnetid) as "comment",
			b.creator, b.fileName, b.rnum
		from (select 
				a.boardid, a.nickname, a.subject,
				a.content, a.hitcnt, a.recommendcnt,
				a.createdate, a.creator, a.fileName, @RNUM := @RNUM + 1 rnum
			from (select 
					boardid, nickname, subject,
					content, hitcnt, recommendcnt,
					createdate, creator, fileName, @RNUM := 0
				from BOARD
        		order by boardid desc) a
        ) b left outer join COMMENT_MAIN c on b.boardid = c.boardid
	    where rnum between #startArticleNum# and #endArticleNum#
	    group by
	    	b.boardid, b.nickname, b.subject, 
	    	b.content, b.hitcnt, b.recommendcnt, 
	    	b.createdate, b.rnum, b.creator, b.fileName
	    order by b.boardid desc		
	</select>
	<select id="getTotalNum" resultClass="int">
		select 
			count(boardid)
		from BOARD
	</select>
	<select id="getSearchTotalNum" resultClass="int">
		select 
			count(boardid)
		from BOARD
		where $type$ like '%$keyword$%'
	</select>
	<select id="searchArticle" parameterClass="java.util.HashMap" resultClass="BoardModel">
		select 
			b.boardid, b.nickname, b.subject,
			b.content, b.hitcnt, b.recommendcnt,
			DATE_FORMAT(b.createdate, '%Y-%m-%d %H:%i:%s') writeDate,
			count(c.boardid) as "comment", 
			b.creator, b.fileName, b.rnum
		from (select 
				a.boardid, a.nickname, a.subject,
				a.content, a.hitcnt, a.recommendcnt,
				a.createdate, a.creator, a.fileName, @RNUM := @RNUM + 1 rnum
			from (select 
					boardid, nickname, subject,
					content, hitcnt, recommendcnt,
					createdate, creator, fileName, @RNUM := 0
				from BOARD
				where $type$ like '%$keyword$%'
        		order by boardid desc) a
        ) b left outer join COMMENT_MAIN c on b.boardid = c.boardid
	    where rnum between #startArticleNum# and #endArticleNum#
	    group by 
	    	b.boardid, b.nickname, b.subject, 
	    	b.content, b.hitcnt, b.recommendcnt, 
	    	b.createdate, b.rnum, b.creator, b.fileName
	    order by b.boardid desc		
	</select>
	<select id="getOneArticle" parameterClass="int" resultClass="BoardModel">
		select
			boardid,
			nickname,
			subject,
			content,
			hitcnt,
			recommendcnt,
			createdate,
			creator,
			fileName
		from BOARD
    	where boardid = #idx#
	</select>
	<select id="getCommentList" parameterClass="int" resultClass="BoardCommentModel">
		select 
			commentid, writer, content, 
			createdate, boardid, creator
		from COMMENT_MAIN
  		where boardid = #idx#
  		order by commentid desc
	</select>
	<select id="getOneComment" parameterClass="int" resultClass="BoardCommentModel">
		select 
			commentid, writer,
			content, 
			createdate, boardid, creator
		from COMMENT_MAIN
  		where commentid = #idx#		
	</select>
	<insert id="writeArticle" parameterClass="BoardModel">
		insert into BOARD(writer, subject, content, hitcnt, recommendcnt, createdate, creator, fileName)
			values(#writer#, #subject#, #content#, 0, 0, now(), #writerId#, #fileName#)
	</insert>
	<insert id="writeComment" parameterClass="BoardCommentModel">
		insert into COMMENT_MAIN(writer, content, createdate, boardid, creator)
			values(#writer#, #content#, now(), #linkedArticleNum#, #writerId#)
	</insert>
	
	<update id="updateHitcount" parameterClass="java.util.HashMap">
		update 
			BOARD 
		set hitcnt = #hitcount#
		where boardid = #idx#
	</update>
	<update id="updateRecommendcount" parameterClass="java.util.HashMap">
		update
			BOARD
		set recommendcnt = #recommendcount#
		where boardid = #idx#
	</update>
	<delete id="deleteComment" parameterClass="int">
		delete
		from COMMENT_MAIN
		where commnetid = #idx#
	</delete>
	<delete id="deleteArticle" parameterClass="int">
		delete
		from BOARD
		where boardid = #idx#	
	</delete>
	<update id="modifyArticle" parameterClass="BoardModel">
		update BOARD
		set subject = #subject#,
			content = #content#,
			fileName = #fileName#
		where boardid = #idx#
	</update>
</sqlMap>







